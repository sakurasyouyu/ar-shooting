<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebAR Sky Shooter</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    
    <style>
        /* UIレイヤーのスタイル */
        body { margin: 0; overflow: hidden; font-family: 'Helvetica Neue', sans-serif; }
        
        /* スコア表示 */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* 3Dシーンへのタップを妨げない */
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #header {
            padding: 20px;
            color: #00ffcc;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            font-size: 24px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            pointer-events: auto; /* ボタンを押せるようにする */
        }

        button {
            background: #00ffcc;
            border: none;
            padding: 10px 20px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            color: #000;
            font-weight: bold;
        }

        /* カメラ背景用のビデオ要素（A-Frameの背景として使用） */
        #cam-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="header">
            <span>SCORE: <span id="score">0</span></span>
            <span style="font-size: 14px; color: white;">AR SHOOTER</span>
        </div>
        <div id="message">
            <h2>AR Sky Shooter</h2>
            <p>スマホを動かして敵を探せ！<br>画面タップで発射</p>
            <button id="start-btn">GAME START</button>
        </div>
    </div>

    <video id="cam-video" autoplay muted playsinline></video>

    <a-scene vr-mode-ui="enabled: false" embedded renderer="alpha: true">
        
        <a-assets>
            <img id="enemy-tex" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/cubes.jpg"> </a-assets>

        <a-entity id="camera-rig">
            <a-camera position="0 1.6 0" look-controls="enabled: true" wasd-controls="enabled: false">
                <a-entity 
                    cursor="fuse: false"
                    position="0 0 -1"
                    geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                    material="color: #00ffcc; shader: flat"
                    animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.1 0.1 0.1; to: 1 1 1"
                    raycaster="objects: .enemy">
                </a-entity>
            </a-camera>
        </a-entity>

        <a-light type="ambient" color="#FFF"></a-light>
        <a-light type="directional" position="-1 1 0"></a-light>

        <a-entity id="enemy-container"></a-entity>

    </a-scene>

    <script>
        // ゲームの状態管理
        let score = 0;
        let isPlaying = false;
        const scoreEl = document.getElementById('score');
        const container = document.getElementById('enemy-container');
        const startBtn = document.getElementById('start-btn');
        const messageBox = document.getElementById('message');
        const video = document.getElementById('cam-video');

        // カメラの起動処理
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, 
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("Camera access denied or not available:", err);
                alert("カメラの起動に失敗しました。設定を確認してください。");
            }
        }

        // 敵をランダムな位置に生成する関数
        function spawnEnemy() {
            if (!isPlaying) return;

            const enemy = document.createElement('a-entity');
            enemy.setAttribute('class', 'enemy');
            
            // 球面座標系を使ってプレイヤーの周囲(半径5m〜8m)にランダム配置
            const radius = 5 + Math.random() * 3;
            const theta = Math.random() * 360; // 水平角度
            const phi = Math.random() * 60 - 10; // 垂直角度（あまり上すぎると首が痛いので調整）

            // 座標変換 (Degree to Radian)
            const x = radius * Math.cos(theta * Math.PI / 180);
            const y = radius * Math.sin(phi * Math.PI / 180); // 高さはある程度制限
            const z = radius * Math.sin(theta * Math.PI / 180);

            enemy.setAttribute('position', `${x} ${y} ${z}`);
            
            // 敵の見た目（赤い球体の中にドローンっぽい箱）
            enemy.innerHTML = `
                <a-sphere radius="0.5" color="#ff0000" opacity="0.7"></a-sphere>
                <a-box depth="0.6" height="0.2" width="0.6" color="#333"></a-box>
                <a-animation attribute="position" to="0 0 0" dur="10000"></a-animation>
            `;
            
            // 自分の方を向く
            enemy.setAttribute('look-at', '[camera]');

            // クリック（タップ）時のイベントリスナー
            enemy.addEventListener('click', () => {
                // 爆発エフェクト（簡易的に拡大して消える）
                enemy.setAttribute('material', 'color', 'orange');
                
                // スコア加算
                score += 100;
                scoreEl.innerText = score;

                // 敵を削除
                setTimeout(() => {
                    if(enemy.parentNode) enemy.parentNode.removeChild(enemy);
                }, 100);

                // 次の敵をすぐに呼ぶ（ゲーム性を高める）
                spawnEnemy();
            });

            container.appendChild(enemy);
        }

        // ゲーム開始処理
        startBtn.addEventListener('click', () => {
            isPlaying = true;
            messageBox.style.display = 'none';
            startCamera();
            
            // 初期敵を5体生成
            for(let i=0; i<5; i++) {
                spawnEnemy();
            }

            // 定期的に敵を追加（難易度調整）
            setInterval(() => {
                if(document.querySelectorAll('.enemy').length < 10) {
                    spawnEnemy();
                }
            }, 3000);
        });

        // 画面全体のタップイベント（A-Frameのカーソルイベントをトリガー）
        // スマホでは画面をタップすると、カメラ中央（レティクル）にあるオブジェクトに対してclickイベントが飛ぶ仕組みを利用
        document.body.addEventListener('click', () => {
            // 効果音などを入れるならここ
        });

    </script>
</body>
</html>
